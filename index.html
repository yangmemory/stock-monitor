<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>海克斯科技 - 智能交易终端</title>
    <style>
        :root {
            --hex-gold: #c8aa6e;
            --hex-blue: #0ac8b9;
            --hex-border: #785a28;
            --bg-dark: #010a13;
            --panel-bg: rgba(9, 20, 40, 0.95);
            --up-red: #ff4e50;
            --down-green: #00ff66;
            --ai-purple: #a066ff;
        }

        body {
            background: radial-gradient(circle at center, #051a27 0%, #010a13 100%);
            color: #f0e6d2;
            font-family: "Microsoft YaHei", sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .terminal-container {
            width: 95%; max-width: 1200px; margin: 30px 0;
            border: 2px solid var(--hex-border); background: var(--panel-bg);
            padding: 25px; box-shadow: 0 0 40px rgba(0, 0, 0, 0.9); position: relative;
        }

        .terminal-container::before {
            content: ""; position: absolute; top: 0; left: 0; right: 0; height: 2px;
            background: linear-gradient(90deg, transparent, var(--hex-gold), transparent);
        }

        .header-main { text-align: center; margin-bottom: 20px; }
        h2 { margin: 0; letter-spacing: 6px; color: var(--hex-gold); text-shadow: 0 0 15px rgba(200, 170, 110, 0.5); text-transform: uppercase; }
        
        .timer-zone {
            display: flex; justify-content: space-around; align-items: center; padding: 15px;
            border: 1px double var(--hex-border); background: rgba(0, 0, 0, 0.5); margin-bottom: 5px; border-radius: 2px;
        }

        #beijingTime { color: var(--hex-blue); font-family: "Courier New", monospace; font-size: 20px; font-weight: bold; }
        #marketCountdown { color: var(--hex-gold); font-size: 14px; letter-spacing: 1px; }

        .ai-info-panel {
            width: 100%; height: 55px; background: rgba(160, 102, 255, 0.08);
            border: 1px solid rgba(160, 102, 255, 0.3); margin-bottom: 25px;
            display: flex; align-items: center; overflow: hidden; position: relative;
        }

        .ai-info-panel::before {
            content: "HEXTECH AI ANALYST"; background: var(--ai-purple); color: white;
            font-size: 10px; font-weight: bold; padding: 0 15px; height: 100%;
            display: flex; align-items: center; z-index: 2; width: 140px; text-align: center;
        }

        #aiStrategyBox {
            flex: 1; padding: 0 20px; font-size: 13px; color: #f0e6d2;
            transition: all 0.3s ease-in-out; transform: translateY(10px); opacity: 0;
            display: flex; flex-direction: column; justify-content: center;
        }

        #aiStrategyBox.slide-in { transform: translateY(0); opacity: 1; }

        .ai-val { color: var(--hex-blue); font-weight: bold; padding: 0 4px; }
        .ai-warn { color: var(--up-red); font-weight: bold; }

        /* 优化后的控制区：不再挤在一起 */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(200, 170, 110, 0.03);
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(120, 90, 40, 0.2);
            gap: 20px;
            flex-wrap: wrap;
        }

        .main-inputs { display: flex; gap: 15px; flex: 1; align-items: center; }
        .data-management { display: flex; gap: 10px; }

        .lol-btn {
            background: linear-gradient(to bottom, #1e2328 0%, #111111 100%);
            border: 1px solid var(--hex-gold); color: var(--hex-gold);
            cursor: pointer; font-weight: bold; text-transform: uppercase;
            transition: 0.2s; display: inline-flex; align-items: center; justify-content: center;
        }
        .lol-btn:hover { background: var(--hex-gold); color: #010a13; box-shadow: 0 0 15px var(--hex-gold); }

        .action-btn-large { padding: 6px 16px; font-size: 11px; min-width: 80px; margin-left: 8px; }
        .btn-edit { border-color: var(--hex-blue); color: var(--hex-blue); }
        .btn-edit:hover { background: var(--hex-blue); color: #010a13; box-shadow: 0 0 15px var(--hex-blue); }
        .btn-remove { border-color: var(--up-red); color: var(--up-red); }
        .btn-remove:hover { background: var(--up-red); color: #fff; box-shadow: 0 0 15px var(--up-red); }

        input { background: #1e2328; border: 1px solid var(--hex-border); color: #f0e6d2; padding: 10px 15px; outline: none; font-size: 13px; flex: 1; min-width: 80px; }
        input:focus { border-color: var(--hex-gold); box-shadow: 0 0 10px rgba(200, 170, 110, 0.3); }

        table { width: 100%; border-collapse: collapse; }
        th { border-bottom: 2px solid var(--hex-border); padding: 15px 12px; color: var(--hex-blue); text-align: left; font-size: 13px; }
        td { padding: 18px 12px; border-bottom: 1px solid rgba(120, 90, 40, 0.1); }
        tr.stock-row:hover { background: rgba(10, 200, 185, 0.05); cursor: pointer; }

        .ai-tag { padding: 8px 12px; border-radius: 1px; font-size: 11px; font-weight: bold; display: inline-block; min-width: 155px; text-align: center; }
        .ai-buy { background: var(--up-red); color: white; }
        .ai-sell { background: var(--down-green); color: black; }
        .ai-hold { border: 1px solid var(--ai-purple); color: var(--ai-purple); }

        @keyframes alert-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); box-shadow: 0 0 15px currentColor; } }
        .flash-alert { animation: alert-pulse 1s infinite; }

        .up { color: var(--up-red); font-weight: bold; }
        .down { color: var(--down-green); font-weight: bold; }

        .market-view { display: none; margin-bottom: 25px; border: 1px solid var(--hex-blue); background: #000; padding: 15px; }
        .market-grid { display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        .order-book { font-family: "Courier New", monospace; font-size: 13px; border-left: 1px solid #333; padding-left: 15px; }
        .order-row { display: flex; justify-content: space-between; margin: 5px 0; }
        .status-bar { margin-top: 30px; font-size: 11px; color: #444; text-align: center; letter-spacing: 2px; }
    </style>
</head>
<body>

<div class="terminal-container">
    <div class="header-main">
        <h2>海克斯科技 - 智能交易终端</h2>
    </div>

    <div class="timer-zone">
        <div id="beijingTime">同步中...</div>
        <div id="marketCountdown">正在扫描全局市场环境...</div>
    </div>

    <div class="ai-info-panel">
        <div id="aiStrategyBox">等待海克斯核心载入最新分析结论...</div>
    </div>
    
    <div class="controls">
        <div class="main-inputs">
            <input type="text" id="stockCode" placeholder="代码 (sh600519)">
            <input type="number" id="buyPrice" placeholder="持仓成本">
            <input type="number" id="buyQty" placeholder="持股数量">
            <button class="lol-btn" style="padding: 10px 30px; min-width: 120px;" onclick="addStock()" id="submitBtn">注入资产</button>
        </div>
        <div class="data-management">
            <button class="lol-btn" style="padding: 10px 15px; color: var(--hex-blue); border-color: var(--hex-blue);" onclick="exportData()">导出存档</button>
            <button class="lol-btn" style="padding: 10px 15px;" onclick="document.getElementById('importFile').click()">导入存档</button>
            <input type="file" id="importFile" hidden onchange="importData(event)">
        </div>
    </div>

    <div id="chartArea" class="market-view">
        <div style="margin-bottom:15px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <button class="lol-btn" style="padding: 5px 15px; font-size: 11px;" onclick="changeChart('min')">实时分时</button>
                <button class="lol-btn" style="padding: 5px 15px; font-size: 11px; margin-left: 10px;" onclick="changeChart('daily')">日K线图</button>
            </div>
            <button class="lol-btn btn-remove" style="padding: 5px 15px; font-size: 11px;" onclick="closeChart()">停止追踪</button>
        </div>
        <div class="market-grid">
            <div style="text-align: center;"><img id="chartImg" src="" style="max-width: 100%; border: 1px solid #222;"></div>
            <div class="order-book" id="orderBookBody">
                <div style="color:var(--hex-blue); border-bottom:1px solid #333; padding-bottom:8px; margin-bottom:10px; font-weight: bold;">实时盘口 (五档)</div>
                <div id="sellList"></div>
                <div style="height:1px; background:#333; margin:10px 0;"></div>
                <div id="buyList"></div>
            </div>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>资产标的</th>
                <th>最新价格</th>
                <th>持仓 / 成本</th>
                <th>盈亏金额</th>
                <th>AI 动作建议</th>
                <th style="text-align: right; padding-right: 30px;">管理终端</th>
            </tr>
        </thead>
        <tbody id="stockBody"></tbody>
    </table>
    <div class="status-bar" id="updateTime">HEXTECH CORE V4.2 - UI 布局深度优化完成</div>
</div>

<script>
    let stockData = JSON.parse(localStorage.getItem('myHexStocks')) || [];
    let currentChartCode = "";
    let lastAIText = "";

    function updateMarketClock() {
        const now = new Date();
        const bjTime = document.getElementById('beijingTime');
        if (bjTime) bjTime.innerText = "北京时间: " + now.toLocaleTimeString('zh-CN', { hour12: false });
        const h = now.getHours(), m = now.getMinutes(), t = h * 60 + m, d = now.getDay();
        let s = "";
        if (d === 0 || d === 6) s = "休市中 (周末)";
        else if (t < 570) s = "距离开盘: " + calcTimeDiff(9, 30);
        else if (t >= 570 && t < 690) s = "交易中 (早盘) | 距午休: " + calcTimeDiff(11, 30);
        else if (t >= 690 && t < 780) s = "午间休市 | 距午盘: " + calcTimeDiff(13, 0);
        else if (t >= 780 && t < 900) s = "交易中 (午盘) | 距收盘: " + calcTimeDiff(15, 0);
        else s = "已收盘";
        const mCount = document.getElementById('marketCountdown');
        if (mCount) mCount.innerText = s;
    }

    function calcTimeDiff(tH, tM) {
        const now = new Date(), target = new Date(); target.setHours(tH, tM, 0);
        let diff = Math.floor((target - now) / 1000); if (diff < 0) return "00:00:00";
        const h = Math.floor(diff / 3600), m = Math.floor((diff % 3600) / 60), s = diff % 60;
        return `${h > 0 ? h + ":" : ""}${m < 10 ? '0' + m : m}:${s < 10 ? '0' + s : s}`;
    }

    function updateAIInfoBox(code) {
        if (!code) { setAIText("<div>请选择资产开启实时战略监控模式。</div>"); return; }
        const varName = "v_" + code;
        if (!window[varName]) return;
        const d = window[varName].split('~');
        const item = stockData.find(s => s.code === code);
        const name = d[1], current = parseFloat(d[3]), cost = item ? parseFloat(item.cost) : 0;
        const low = parseFloat(d[34]), high = parseFloat(d[33]), open = parseFloat(d[5]);
        const support = low.toFixed(2), resistance = high.toFixed(2), buyPoint = (low + (high - low) * 0.382).toFixed(2);
        const trend = current > open ? "看多" : "看空";
        let html = `<div style="display:flex; justify-content:space-between; width:100%;">
                <span>追踪: <b class="ai-val">${name}</b> | 趋势: <b class="${current > open ? 'up' : 'down'}">${trend}</b></span>
                <span>阻力位: <b class="ai-val">${resistance}</b> | 支撑位: <b class="ai-val">${support}</b></span>
            </div>
            <div style="margin-top:5px; font-size:12px; color:rgba(240, 230, 210, 0.7);">
                战略建议: <span class="ai-val">建议在 ${buyPoint} 支撑区寻找机会。</span>`;
        if (cost > 0) {
            const pRate = (current - cost) / cost;
            html += ` | 盈亏: <b class="${pRate >= 0 ? 'up' : 'down'}">${(pRate * 100).toFixed(2)}%</b>`;
            if (pRate < -0.05) html += ` <span class="ai-warn">! 建议结合支撑位风控。</span>`;
        }
        html += `</div>`;
        setAIText(html);
    }

    function setAIText(html) {
        if (html === lastAIText) return;
        const box = document.getElementById('aiStrategyBox');
        box.classList.remove('slide-in');
        setTimeout(() => { box.innerHTML = html; box.classList.add('slide-in'); lastAIText = html; }, 150);
    }

    function fetchData() {
        if (stockData.length === 0) { document.getElementById('stockBody').innerHTML = '<tr><td colspan="6" style="text-align:center;color:#444;padding:40px">等待注入资产存档...</td></tr>'; return; }
        const codes = stockData.map(s => s.code);
        const script = document.createElement('script');
        script.src = `https://qt.gtimg.cn/q=${codes.join(',')}`;
        document.body.appendChild(script);
        script.onload = function() {
            let html = '';
            stockData.forEach((item, index) => {
                const varName = "v_" + item.code;
                if (window[varName]) {
                    const d = window[varName].split('~');
                    const price = parseFloat(d[3]), change = d[32], isUp = parseFloat(change) >= 0;
                    let pnl = '--';
                    if (item.cost > 0 && item.qty > 0) {
                        const amt = (price - item.cost) * item.qty;
                        pnl = `<span class="${amt >= 0 ? 'up' : 'down'}">${amt >= 0 ? '+' : ''}${amt.toFixed(2)}</span>`;
                    }
                    html += `<tr class="stock-row" onclick="showChart('${item.code}')">
                        <td><span style="color:var(--hex-gold)">✦</span> ${d[1]}<br><small style="color:#555">${item.code.toUpperCase()}</small></td>
                        <td class="${isUp ? 'up' : 'down'} font-bold">${price.toFixed(2)}</td>
                        <td style="font-size:12px">${item.qty} / <span style="color:var(--hex-gold)">${item.cost}</span></td>
                        <td>${pnl}</td>
                        <td>${getAIDynamicAction(d, item)}</td>
                        <td style="text-align: right; padding-right: 20px;">
                            <button class="lol-btn action-btn-large btn-edit" onclick="editStock(event, ${index})">修改</button>
                            <button class="lol-btn action-btn-large btn-remove" onclick="removeStock(event, ${index})">移除</button>
                        </td>
                    </tr>`;
                }
            });
            document.getElementById('stockBody').innerHTML = html;
            if(currentChartCode) { updateOrderBook(currentChartCode); updateAIInfoBox(currentChartCode); }
        };
    }

    function getAIDynamicAction(d, item) {
        const current = parseFloat(d[3]), cost = parseFloat(item.cost), change = parseFloat(d[32]), low = parseFloat(d[34]);
        const aiBuyPoint = (low + (parseFloat(d[33]) - low) * 0.382).toFixed(2);
        let label = "", cssClass = "ai-hold", isAlert = false;
        if (cost > 0) {
            const pRate = (current - cost) / cost;
            if (pRate > 0.05) { label = `分批止盈: ${(current*0.995).toFixed(2)}`; cssClass = "ai-sell"; isAlert = current >= (current*0.995); }
            else if (pRate < -0.05 && current > low) { label = `补仓摊薄: ${(current*1.005).toFixed(2)}`; cssClass = "ai-buy"; isAlert = current <= (current*1.005); }
        }
        if (!label) {
            if (change >= 2.0) { label = `建议买入: ${aiBuyPoint}`; cssClass = "ai-buy"; isAlert = current <= aiBuyPoint; }
            else if (change <= -2.0) { label = `建议卖出: ${(current*0.985).toFixed(2)}`; cssClass = "ai-sell"; isAlert = current >= (current*0.985); }
            else { label = "持币观望"; cssClass = "ai-hold"; }
        }
        return `<span class="ai-tag ${cssClass} ${isAlert ? 'flash-alert' : ''}">${label}</span>`;
    }

    function addStock() {
        const c = document.getElementById('stockCode').value.trim().toLowerCase(), cost = parseFloat(document.getElementById('buyPrice').value) || 0, qty = parseFloat(document.getElementById('buyQty').value) || 0;
        if (!c) return;
        const i = stockData.findIndex(s => s.code === c);
        if (i > -1) stockData[i] = { code: c, cost, qty };
        else stockData.push({ code: c, cost, qty });
        saveAndRefresh();
    }
    function editStock(e, i) { e.stopPropagation(); const item = stockData[i]; document.getElementById('stockCode').value = item.code; document.getElementById('buyPrice').value = item.cost; document.getElementById('buyQty').value = item.qty; document.getElementById('submitBtn').innerText = "确认修改"; window.scrollTo({ top: 0, behavior: 'smooth' }); }
    function removeStock(e, i) { e.stopPropagation(); if(confirm("移除资产监控？")) { stockData.splice(i, 1); saveAndRefresh(); } }
    function saveAndRefresh() { localStorage.setItem('myHexStocks', JSON.stringify(stockData)); document.getElementById('submitBtn').innerText = "注入资产"; fetchData(); }
    function showChart(code) { currentChartCode = code; document.getElementById('chartArea').style.display = 'block'; changeChart('min'); updateAIInfoBox(code); window.scrollTo({ top: 0, behavior: 'smooth' }); }
    function changeChart(t) { document.getElementById('chartImg').src = `https://image.sinajs.cn/newchart/${t}/n/${currentChartCode}.gif?t=${Date.now()}`; }
    function closeChart() { currentChartCode = ""; document.getElementById('chartArea').style.display = 'none'; updateAIInfoBox(null); }
    function updateOrderBook(code) {
        const d = window["v_" + code].split('~');
        let sH = ''; for(let i=5; i>=1; i--) sH += `<div class="order-row"><span>卖${i}</span><span class="${parseFloat(d[19+(i-1)*2])>=d[4]?'up':'down'}">${parseFloat(d[19+(i-1)*2]).toFixed(2)}</span><span style="color:var(--hex-gold)">${Math.floor(d[20+(i-1)*2]/100)}</span></div>`;
        document.getElementById('sellList').innerHTML = sH;
        let bH = ''; for(let i=1; i<=5; i++) bH += `<div class="order-row"><span>买${i}</span><span class="${parseFloat(d[9+(i-1)*2])>=d[4]?'up':'down'}">${parseFloat(d[9+(i-1)*2]).toFixed(2)}</span><span style="color:var(--hex-gold)">${Math.floor(d[10+(i-1)*2]/100)}</span></div>`;
        document.getElementById('buyList').innerHTML = bH;
    }
    function exportData() { const blob = new Blob([JSON.stringify(stockData)], {type:"application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download='HEXTECH_PORTFOLIO.json'; a.click(); }
    function importData(e) { const r = new FileReader(); r.onload = (f) => { try { stockData = JSON.parse(f.target.result); saveAndRefresh(); } catch(e) {} }; r.readAsText(e.target.files[0]); }

    setInterval(updateMarketClock, 1000);
    setInterval(fetchData, 3000);
    window.onload = () => { updateMarketClock(); fetchData(); };
</script>

</body>
</html>
