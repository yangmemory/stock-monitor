<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>海克斯科技 - 智能交易終端</title>
    <style>
        :root {
            --hextech-gold: #c8aa6e;
            --hextech-blue: #0ac8b9;
            --bg-dark: #010a13;
            --panel-bg: rgba(30, 35, 40, 0.95);
            --up-red: #ff4e50;
            --down-green: #00ff66;
            --ai-purple: #a066ff;
        }

        body {
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at center, #051a27 0%, #010a13 100%);
            color: #f0e6d2;
            font-family: "Microsoft YaHei", sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .terminal-container {
            width: 95%;
            max-width: 1200px;
            margin: 20px 0;
            border: 2px solid var(--hextech-gold);
            background: var(--panel-bg);
            padding: 20px;
            box-shadow: 0 0 30px rgba(10, 200, 185, 0.1);
        }

        .header-main { text-align: center; margin-bottom: 15px; }
        h2 { margin: 0; letter-spacing: 4px; color: var(--hextech-gold); text-shadow: 0 0 10px rgba(200, 170, 110, 0.5); }
        
        .timer-zone {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 12px;
            border: 1px double var(--hextech-gold);
            background: rgba(0, 0, 0, 0.4);
            margin-bottom: 20px;
            border-radius: 4px;
        }

        #beijingTime { color: var(--hextech-blue); font-family: "Courier New", monospace; font-size: 18px; font-weight: bold; }
        #marketCountdown { color: var(--hextech-gold); font-size: 14px; }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(200, 170, 110, 0.05);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .input-group { display: flex; gap: 8px; }
        input { background: #1e2328; border: 1px solid var(--hextech-gold); color: #f0e6d2; padding: 8px; outline: none; font-size: 13px; }
        button { background: #1e2328; border: 1px solid var(--hextech-gold); color: var(--hextech-gold); padding: 8px 15px; cursor: pointer; font-weight: bold; }
        button:hover { background: var(--hextech-gold); color: #000; }

        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { border-bottom: 2px solid var(--hextech-gold); padding: 12px; color: var(--hextech-blue); text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #3c3c41; }
        tr.stock-row:hover { background: rgba(10, 200, 185, 0.08); cursor: pointer; }

        /* AI 指令標籤 - 更加直接 */
        .ai-tag { padding: 5px 12px; border-radius: 2px; font-size: 12px; font-weight: bold; text-align: center; display: inline-block; min-width: 60px; }
        .ai-buy { background: var(--up-red); color: white; box-shadow: 0 0 12px var(--up-red); }
        .ai-sell { background: var(--down-green); color: black; }
        .ai-hold { border: 1px solid var(--ai-purple); color: var(--ai-purple); }

        .up { color: var(--up-red); font-weight: bold; }
        .down { color: var(--down-green); font-weight: bold; }

        .chart-container {
            display: none;
            background: #000;
            text-align: center;
            padding: 15px;
            border: 1px dashed var(--hextech-blue);
            margin-bottom: 20px;
        }
        
        .status-bar { margin-top: 20px; font-size: 11px; color: #555; text-align: center; }
    </style>
</head>
<body>

<div class="terminal-container">
    <div class="header-main">
        <h2>海克斯科技 - 智能交易終端</h2>
    </div>

    <div class="timer-zone">
        <div id="beijingTime">同步中...</div>
        <div id="marketCountdown">掃描中...</div>
    </div>
    
    <div class="controls">
        <div class="input-group">
            <input type="text" id="stockCode" placeholder="代碼 (sh600519)">
            <input type="number" id="buyPrice" style="width:70px" placeholder="成本">
            <input type="number" id="buyQty" style="width:70px" placeholder="持股">
            <button onclick="addStock()">注入資產</button>
        </div>
        <div class="input-group">
            <button onclick="exportData()" style="color:var(--hextech-blue); border-color:var(--hextech-blue)">導出資料</button>
            <button onclick="document.getElementById('importFile').click()">導入資料</button>
            <input type="file" id="importFile" hidden onchange="importData(event)">
        </div>
    </div>

    <div id="chartArea" class="chart-container">
        <div style="margin-bottom:10px">
            <button onclick="changeChart('min')">分時圖</button>
            <button onclick="changeChart('daily')">日K線</button>
            <button style="color:var(--up-red)" onclick="closeChart()">收起圖表</button>
        </div>
        <img id="chartImg" src="" style="max-width: 100%;">
    </div>

    <table>
        <thead>
            <tr>
                <th>資產標的</th>
                <th>最新價格</th>
                <th>漲跌幅</th>
                <th>盈虧金額</th>
                <th>AI 建議</th>
                <th>指令</th>
            </tr>
        </thead>
        <tbody id="stockBody"></tbody>
    </table>

    <div class="status-bar" id="updateTime">系統穩定運行中...</div>
</div>

<script>
    let stockData = JSON.parse(localStorage.getItem('myHexStocks')) || [];
    let currentChartCode = "";

    function updateMarketClock() {
        const now = new Date();
        document.getElementById('beijingTime').innerText = "北京時間: " + now.toLocaleTimeString('zh-CN', { hour12: false });
        const hour = now.getHours();
        const min = now.getMinutes();
        const totalMin = hour * 60 + min;
        const day = now.getDay();
        let statusText = "";
        if (day === 0 || day === 6) { statusText = "休市中 (周末)"; } 
        else {
            if (totalMin < 570) statusText = "距離開盤: " + calcTimeDiff(9, 30);
            else if (totalMin >= 570 && totalMin < 690) statusText = "交易中 (早盤) | 距午休: " + calcTimeDiff(11, 30);
            else if (totalMin >= 690 && totalMin < 780) statusText = "午間休市 | 距開盤: " + calcTimeDiff(13, 0);
            else if (totalMin >= 780 && totalMin < 900) statusText = "交易中 (午盤) | 距收盤: " + calcTimeDiff(15, 0);
            else statusText = "已收盤";
        }
        document.getElementById('marketCountdown').innerText = statusText;
    }

    function calcTimeDiff(tH, tM) {
        const now = new Date(); const target = new Date(); target.setHours(tH, tM, 0);
        let diff = Math.floor((target - now) / 1000);
        const h = Math.floor(diff / 3600); const m = Math.floor((diff % 3600) / 60); const s = diff % 60;
        return `${h > 0 ? h + ":" : ""}${m < 10 ? '0' + m : m}:${s < 10 ? '0' + s : s}`;
    }

    // AI 決策建議 - 簡化指令
    function getAISuggestion(change) {
        const num = parseFloat(change);
        if (num >= 2.0) return '<span class="ai-tag ai-buy">建議買入</span>';
        if (num <= -2.0) return '<span class="ai-tag ai-sell">建議賣出</span>';
        return '<span class="ai-tag ai-hold">觀望</span>';
    }

    function addStock() {
        const code = document.getElementById('stockCode').value.trim().toLowerCase();
        const cost = parseFloat(document.getElementById('buyPrice').value) || 0;
        const qty = parseFloat(document.getElementById('buyQty').value) || 0;
        if (code) {
            const index = stockData.findIndex(s => s.code === code);
            if (index > -1) stockData[index] = { code, cost, qty };
            else stockData.push({ code, cost, qty });
            localStorage.setItem('myHexStocks', JSON.stringify(stockData));
            fetchData();
        }
    }

    function fetchData() {
        if (stockData.length === 0) {
            document.getElementById('stockBody').innerHTML = '<tr><td colspan="6" style="text-align:center;color:#444">等待資產注入...</td></tr>';
            return;
        }
        const codes = stockData.map(s => s.code);
        const oldScript = document.getElementById('api-script');
        if (oldScript) oldScript.remove();
        const script = document.createElement('script');
        script.id = 'api-script';
        script.src = `https://qt.gtimg.cn/q=${codes.join(',')}`;
        document.body.appendChild(script);
        script.onload = function() {
            let html = '';
            stockData.forEach((item, index) => {
                const varName = "v_" + item.code;
                if (window[varName]) {
                    const d = window[varName].split('~');
                    const price = parseFloat(d[3]); const change = d[32]; const isUp = parseFloat(change) >= 0;
                    let pnl = '--';
                    if (item.cost > 0 && item.qty > 0) {
                        const amt = (price - item.cost) * item.qty;
                        pnl = `<span class="${amt >= 0 ? 'up' : 'down'}">${amt.toFixed(2)}</span>`;
                    }
                    html += `<tr class="stock-row" onclick="showChart('${item.code}')">
                        <td><span style="color:var(--hextech-gold)">✦</span> ${d[1]}<br><small style="color:#555">${item.code.toUpperCase()}</small></td>
                        <td class="${isUp ? 'up' : 'down'}">${price.toFixed(2)}</td>
                        <td class="${isUp ? 'up' : 'down'}">${isUp ? '+' : ''}${change}%</td>
                        <td>${pnl}</td>
                        <td>${getAISuggestion(change)}</td>
                        <td><button onclick="removeStock(event, ${index})" style="color:#ff4e50; border-color:#ff4e50; font-size:10px">移除</button></td>
                    </tr>`;
                }
            });
            document.getElementById('stockBody').innerHTML = html;
        };
    }

    function removeStock(e, i) { e.stopPropagation(); if(confirm("確定移除？")) { stockData.splice(i, 1); localStorage.setItem('myHexStocks', JSON.stringify(stockData)); fetchData(); } }
    function showChart(code) { currentChartCode = code; document.getElementById('chartArea').style.display = 'block'; changeChart('min'); window.scrollTo({ top: 0, behavior: 'smooth' }); }
    function changeChart(type) { document.getElementById('chartImg').src = `https://image.sinajs.cn/newchart/${type}/n/${currentChartCode}.gif?t=${Date.now()}`; }
    function closeChart() { document.getElementById('chartArea').style.display = 'none'; }
    function exportData() { const blob = new Blob([JSON.stringify(stockData)], {type:"application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download='資產備份.json'; a.click(); }
    function importData(e) { const reader = new FileReader(); reader.onload = (f) => { stockData = JSON.parse(f.target.result); localStorage.setItem('myHexStocks', JSON.stringify(stockData)); fetchData(); }; reader.readAsText(e.target.files[0]); }

    setInterval(updateMarketClock, 1000);
    setInterval(fetchData, 5000);
    window.onload = () => { updateMarketClock(); fetchData(); };
</script>

</body>
</html>
