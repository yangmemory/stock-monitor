// 使用更稳定的 JSONP 方式或腾讯接口
function fetchData() {
    if (stocks.length === 0) {
        document.getElementById('stockBody').innerHTML = '<tr><td colspan="4" style="text-align:center">暂无自选股，请在上方添加</td></tr>';
        return;
    }

    // 动态创建脚本标签，绕过跨域限制
    const script = document.createElement('script');
    script.src = `https://qt.gtimg.cn/q=${stocks.join(',')}`; // 改用腾讯接口，更稳定
    document.body.appendChild(script);

    script.onload = function() {
        let html = '';
        stocks.forEach((code, index) => {
            // 腾讯接口返回的数据变量名为 v_代码
            const varName = "v_" + code;
            if (window[varName]) {
                const data = window[varName].split('~');
                const name = data[1];      // 股票名称
                const current = parseFloat(data[3]);  // 当前价
                const lastClose = parseFloat(data[4]); // 昨收
                const changePrice = data[31]; // 涨跌额
                const changePercent = data[32]; // 涨跌幅
                
                const isUp = parseFloat(changePercent) >= 0;

                html += `
                    <tr>
                        <td style="color: #c8aa6e">${name}</td>
                        <td class="${isUp ? 'up' : 'down'}">${current.toFixed(2)}</td>
                        <td class="${isUp ? 'up' : 'down'}">${isUp ? '+' : ''}${changePercent}%</td>
                        <td><button style="background:rgba(255,77,79,0.2); border:1px solid #ff4d4f; color:#ff4d4f; cursor:pointer" onclick="removeStock(${index})">销毁</button></td>
                    </tr>
                `;
            }
        });
        document.getElementById('stockBody').innerHTML = html;
        document.body.removeChild(script); // 清理标签
    };
}
